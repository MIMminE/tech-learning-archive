## OAuth 2.0 Grant Type 개요

OAuth 시스템에서 권한 부여라는 것은 리소스 서버에 있는 사용자 소유 자원에 접근하기 위한 해당 사용자 권한을 클라이언트에게 부여하는 것을 말한다.
일반적인 권한 부여 과정은 다음과 같다.

1) 클라이언트는 사용자 소유 리소스에 접근하기 위해 사용자의 권한이 필요하다.
2) 권한을 얻기 위해 사용자를 인가(Authorization) 서버의 로그인 및 권한 동의 페이지로 리다이렉트한다.
3) 사용자는 인가 서버에 자신의 자격 증명(아이디, 비밀번호 등)으로 인증을 하고, 클라이언트에게 부여할 권한 범위를 선택(동의)한다.
4) 인가 서버는 사용자의 동의 결과에 따라 Access Token(및 필요시 Refresh Token)을 클라이언트에게 발급한다. (일부 플로우에서는 Authorization Code를 먼저 발급)
5) 클라이언트는 Access Token을 사용하여 리소스 서버에 요청을 보내고, 권한 내에서 사용자 자원에 접근할 수 있게 된다.

실제 OAuth 2.0 은 권한 부여를 위한 몇 가지 플로우를 제공하며 각 플로우 별로 사용사례와 세부 과정이 달라진다.

#### Authorization Code Grant Type

서버 사이드 애플리케이션에서 가장 널리 사용되는 권한 부여 방식으로, `Access Token` 를 발급받기 위한 과정이 두 단계로 나누어져 있다.

1) 프런트 클라이언트(공개 클라이언트, 브라우저)에서 인가 서버를 호출하고 사용자가 로그인 및 권한 부여 동의가 이루어지면 인가 서버는 인가 코드라고 하는 임의의 값을 전달한다.
2) 이때 전달되는 인가 코드는 프런트 클라이언트(브라우저)에게 redirect 방식으로 전달되며, 이로 인해 브라우저 상에서 쉽게 노출된다.
3) 프런트 클라이언트는 인가 코드를 받아 자신의 백엔드 서버에 전달하고 백엔드 서버에서 인가 서버에 등록된 자신의 클라이언트 id, password 와 함께 인가 코드를 전송한다.
4) 인가 서버는 클라이언트 id, password 를 통해 클라이언트 신원을 검증하고, 인가 코드가 올바르다면 Access Token 를 반환한다.

이 방식은 프런트 클라이언트가 자신의 백엔드를 통해 2차 요청을 한다는 사실을 인가 서버가 검증할 수 있으며, 클라이언트 시크릿 등의 정보는 백엔드에서만 관리되기에 탈취가 어렵다.

#### Implicit Grant Type [Deprecated]

암시적 권한 부여 타입으로 브라우저 기반의 공개 클라이언트 (SPA 기반 자바스크립트 앱 등) 에서 사용된다.

1) 프런트 클라이언트가 인가 서버를 호출하고 사용자가 로그인 및 권한 부여 동의를 진행한다.
2) 인가 서버는 클라이언트가 지정한 redirect uri 로 Access Token 를 전달한다.

Access Token 이 브라우저 등에 직접 노출되기 때문에 보안에 취약한 편이다. 현재는 이러한 이유로 인해 공식적으로 폐기되었다.

#### Resource Owner Password Credentials Grant Type [Deprecated]

클라이언트가 리소스 소유자 자격증명을 직접 받아 인가 서버에 전달하여 Access Token 를 전달받는 방식이다.
즉, 클라이언트에게 직접 사용자의 자격 증명을 알려주어야 한다. 이러한 방식은 과거에 많이 사용되었지만 보안에 취약하여 현재는 공식적으로 폐기되었다.

OAuth 프레임워크가 등장하게 된 근본적인 이유로는 이렇게 사용자의 신원 정보를 신뢰되지 않은 클라이언트에게 직접 전달되는 것을 막기 위해서도 있다.

#### Client Credentials Grant Type

사용자의 인증이 전혀 개입되지 않으며, 클라이언트 자체의 자격 증명만을 통해 권한이 부여되는 방식이다. 클라이언트 자격 증명에는 client_id 와 client_secret 이 사용된다.
공개 클라이언트에서는 사용되지 않으며 Server to Server 통신에서 널리 사용된다.

신뢰도가 높은 자사 어플리케이션 등에서만 사용되어야 한다.

#### Refresh Token Grant Type

Access Token 를 발급받는 방식(Authorization Code Type, Resource Owner Password Type)에서 함께 전달되는 Refresh Token 를 사용하여 새로운 Access
Token를 발급받는다.
보통 Access Token 은 유효시간이 짧으며 이러한 사유로 인증 및 권한 부여 과정을 반복적으로 해야하는 상황이 발생할 수 있다는 점을 개선하기 위해 사용된다.

Refresh Token 은 노출되면 위험성이 크기 때문에 신뢰성 높은 백서버 등에서 사용되어야 한다.

#### PKCE-enhanced Authorization Code Grant Type

인가 코드 탈취를 막기 위해 임의의 키를 추가로 사용해 보안을 강화한 Authorization Code Grant Type 이다.
보안을 위험 최근에는 권장되는 방식이다.

### 권한 부여 흐름 선택 기준

#### Client Credentials Flow

사용자 없이 클라이언트만 인증하면 되는 경우에 선택하면 된다. 즉, 마이크로 서비스 간 API 호출 또는 시스템 자동화를 통해 백엔드 서버끼리의 통신에서 사용된다.

#### Resource Owner Password Credentials Flow

클라이언트를 매우 신뢰할 수 있는 경우에만 선택해야 한다.
자사 어플리케이션이나 회사 내부에서만 사용되는 공식 앱 등의 사례에서 사용된다.

그 외의 대부분은 `Authorization Code Flow (with PKCE)` 방식을 사용하면 된다.

### 매개 변수 용어

- `client_id` : 인가서버에 등록된 클라이언트에 대해 생성된 고유 아이디
- `client_secret` : 인가서버에 등록된 특정 클라이언트의 client_id 에 대해 생성된 비밀 값
- `response_type` : 애플리케이션이 권한 부여 코드 흐름을 시작하고 있음을 인증 서버에 알린다. code, token, id_token 이 있다.
- `grant_type` : 권한 부여 타입을 지정할 때 사용된다. (authorization_code, password, client_credentials, refresh_token)
- `redirect_uri` : 사용자가 응용 프로그램을 성공적으로 리다이렉트할 uri를 지정한다. 여기서 지정된 uri는 인증 코드를 생성할 때 사용된 redirect_uri 와 일치해야 한다.
- `scope` : 어플리케이션이 사용자 데이터에 접근하는 것을 제한하기 위해 사용된다. email, profile, read, write 등. 사용자에 의해 제한된 권한 인가권을 발행함으로써 데이터 접근을 제한한다.
- `state` : CSRF 공격 방지를 위해 사용된다. 임의의 문자열을 생성하고 요청에 포함하고 사용자가 앱을 승인한 후 서버로부터 동일한 값이 반환되는지 확인한다.

## Authorization Code Grant Type - 권한 부여 코드 승인 방식

1. 사용자가 클라이언트에 대한 요청을 승인하면, 클라이언트가 설정해둔 Redirect URI 로 인가서버가 임시 코드를 담아 리다이렉트를 수행한다.
2. 클라이언트는 해당 임시 코드를 받아 자신의 client_id, client_password 등의 정보와 함께 다시 인가서버에게 전달한다. 이때는 클라이언트는 브라우저와 같은 공개 클라이언트가 아닌, 백 서버에서
   전달하게 되고 이를 받은 인가서버는 액세스 토큰을 반환해준다.
3. 액세스 토큰 발급을 위해 임시 코드와 함께 전달된 클라이언트의 요청에서 인가서버에 정식으로 등록된 클라이언트임을 id와 패스워드를 통해 자격증명을 진행할 수 있으므로 인증 코드 누출이 되더라도 안전하게 사용할
   수 있다.
4. 또한, 백 서버에서 액세서 토큰 발급을 하는 것이므로 브라우저 등에 노출되지 않게되어 임시 코드조차 알아내기 쉽지 않다.

## Implicit Grant Type - 암묵적 승인 방식

## Resource Owner Password Credentials Grant Type - 패스워드 자격증명 승인 방식